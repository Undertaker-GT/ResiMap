let userMarker = null;
let destinationLatLng = null; // guardamos el destino actual


let map;
let routingControl;
let userLocation = null;

// Configuraci√≥n inicial responsive
function setupResponsive() {
  // Ajustar zoom inicial seg√∫n el tama√±o de pantalla
  const zoomLevel = window.innerWidth <= 768 ? 16 : 17;
  map.setView(center, zoomLevel);
  
  // Ajustar controles seg√∫n dispositivo
  if (window.innerWidth <= 768) {
    // M√≥viles: ocultar algunos controles o ajustar posici√≥n
    document.querySelector('.leaflet-control-layers').style.marginTop = '80px';
  }
}

// Detectar cambios de orientaci√≥n
window.addEventListener('orientationchange', function() {
  setTimeout(() => {
    map.invalidateSize();
    setupResponsive();
  }, 200);
});

// Detectar cambios de tama√±o
window.addEventListener('resize', function() {
  map.invalidateSize();
  setupResponsive();
});

// Inicializar configuraci√≥n responsive
document.addEventListener('DOMContentLoaded', function() {
  setupResponsive();
  initSearchModal();

});



// Mapa base centrado en un punto general de la residencial
const center = [14.41137, -90.68142]; // Centro de la residencial
map = L.map('map').setView(center, 17); // Siempre inicia aqu√≠

// Reemplazar la capa actual de OpenStreetMap con esto:
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
}).addTo(map);

const baseLayers = {
  "Sat√©lite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
  "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
};

L.control.layers(baseLayers).addTo(map);

// Lista de sectores con coordenadas
const sectores = {
    "8": {
    name: "Sector 8",
    coords: [14.411844, -90.682780],
    n_casas: 24,
    area: [
      [14.411912, -90.683462], 
      [14.412156, -90.682743], 
      [14.411847, -90.682746], 
      [14.411678, -90.683218], 
      [14.411912, -90.683462]
    ]
  },
    "11": {
    name: "Sector 11",
    coords: [14.411543019450377, -90.68649759953408],
    area: [
      [14.411543019450377, -90.68649759953408], 
      [14.411488119118529, -90.68574166526184], 
      [14.411519667291742, -90.68511626089308], 
      [14.411845244181704, -90.68515274281529], 
      [14.411851553806589, -90.68643351884548],
      [14.411543019450377, -90.68649759953408]
    ]
  },
    "12": {
    name: "Sector 12",
    coords: [14.411901, -90.683698],
    area: [
      [14.411841266804542, -90.68507422981112],  
      [14.411535471311266, -90.68503592424005],
      [14.411664759898208, -90.68435919248456], 
      [14.411890733683165, -90.68366620988074], 
      [14.412139192157516, -90.68386934548488], 
      [14.411841266804542, -90.68507422981112]
    ]
  },
    "13": {
    name: "Sector 13",
    coords: [14.412237839550228, -90.68275619256788],
    area: [
      [14.412210, -90.683727], 
      [14.412434, -90.683271],
      [14.412558, -90.682735], 
      [14.412231, -90.682746], 
      [14.411961, -90.683521], 
      [14.412210, -90.683727]
    ]
  },
    "14": {
    name: "Sector 14",
    coords: [14.412639, -90.682756],
    area: [
      [14.412507, -90.684025], 
      [14.412826, -90.683344],
      [14.412925, -90.682821], 
      [14.412782, -90.682716], 
      [14.412634, -90.682724], 
      [14.412262, -90.683813],
      [14.412507, -90.684025]
    ]
  },
    "15": {
    name: "Sector 15",
    coords: [14.412217687349374, -90.68398293843862],
    area: [
      [14.412240889076273, -90.68511832336306], 
      [14.41191575366781, -90.68509556406758],
      [14.41203056142227, -90.68447063170754], 
      [14.4122032321736, -90.68396518566794], 
      [14.41246958573427, -90.68417191594955], 
      [14.412240889076273, -90.68511832336306]
    ]
  },
    "16": {
    name: "Sector 16",
    coords: [14.411918974917064, -90.68637295561457],
    area: [
      [14.411918974917064, -90.68637295561457], 
      [14.411880051838802, -90.68567469387169],
      [14.411917028763376, -90.68516631915689], 
      [14.4122293862236, -90.68519746464337], 
      [14.412226466997032, -90.68622225161786], 
      [14.411918974917064, -90.68637295561457]
    ]
  },
    "19": {
    name: "Sector 19",
    coords: [14.413122, -90.682523],
    area: [
      [14.414003, -90.683116], 
      [14.413730, -90.682416], 
      [14.413421, -90.682292], 
      [14.413000, -90.682311], 
      [14.413029, -90.682475],
      [14.413177, -90.682620],
      [14.413447, -90.682630],
      [14.413733, -90.683242],
      [14.414003, -90.683116]
    ]
  },
    "20": {
    name: "Sector 20",
    coords: [14.413761, -90.683312],
    area: [
      [14.414255, -90.683945], 
      [14.414247, -90.683773], 
      [14.414031, -90.683169], 
      [14.413756, -90.683301], 
      [14.413943, -90.683827],
      [14.414255, -90.683945]
    ]
  },
    "21": {
    name: "Sector 21",
    coords: [14.413930, -90.683899],
    area: [
      [14.413177, -90.684709], 
      [14.413621, -90.684360], 
      [14.414086, -90.684191], 
      [14.414229, -90.684006], 
      [14.413930, -90.683904],
      [14.413501, -90.684063],
      [14.412938, -90.684484],         
      [14.413177, -90.684709]
    ]
  },
    "22": {
    name: "Sector 22",
    coords: [14.412862, -90.684626],
    area: [
      [14.412808352437802, -90.68548857926251], 
      [14.413080216024518, -90.6848039037431], 
      [14.412869889159241, -90.684606656502], 
      [14.412518119329757, -90.685388059034], 
      [14.412808352437802, -90.68548857926251]
    ]
  },
    "23": {
    name: "Sector 23",
    coords: [14.413130382696735, -90.68491656170323],
    casas: {
      "1": [14.413089782066624, -90.6849668759423],
      "2": [14.41304432073671, -90.68505136552332],
      "3": [14.412992364919676, -90.68513920786695],
      "4": [14.4129417079863, -90.68525923671666],
      "5": [14.412918977307465, -90.68534506740306],
      "6": [14.412908586138677, -90.6854349214036],
      "7": [14.412869970154432, -90.68552065503054],
      "8": [14.412851710677343, -90.68560825992041],
      "9": [14.412834319845006, -90.68568446082921],
      "10": [14.41281261280455, -90.68577252833008],
      "11": [14.412797263637232, -90.68585699215366],
      "12": [14.412754780840253, -90.68602703238845],
      "13": [14.41276318648726, -90.68602552131712],
      "14": [14.412728316100438, -90.68610755732765],
      "15": [14.412718676918423, -90.68618542552316],
      "16": [14.412701791254818, -90.68626857399755],
      "17": [14.413006382454814, -90.68634099363652],
      "18": [14.413027164782328, -90.68625583350186],
      "19": [14.413048596555495, -90.68616463839365],
      "20": [14.41306214611172, -90.68611246246425],
      "21": [14.413090072355697, -90.68601456184115],
      "22": [14.413108256884769, -90.68593141336673],
      "23": [14.413134884230022, -90.68584088881263],
      "24": [14.413152874070155, -90.68576619434846],
      "25": [14.413170484076948, -90.68568106047529],
      "26": [14.413188129372553, -90.68559368077877],
      "27": [14.413207878144103, -90.68551569149105],
      "28": [14.413228011005632, -90.68543388411535],
      "19": [14.413248143865202, -90.68535878226454],
      "30": [14.413278667874785, -90.68528502152083],
      "31": [14.413319583028688, -90.6851991908327],
      "32": [14.413364394855101, -90.6851354883725]
    },
    area: [
      [14.412975911705098, -90.68642899641084], //arriba a la izquierda 
      [14.41336947674023, -90.68512812510417], //arriba derecha 
      [14.413130480234106, -90.68489879624498], //abajo derecha 
      [14.412658980940819, -90.68632439026449], // abajo izquierda
      [14.412975911705098, -90.68642899641084] //arriba izquierda
    ]
  },
    "24": {
    name: "Sector 24",
    coords: [14.413247, -90.684776],
    casas: {
          "1": [14.414300696033376, -90.68412499259824],
          "2": [14.414246792176458, -90.68419607113528],
          "3": [14.414183146641582, -90.68424703310734],
          "4": [14.414111058310448, -90.68430335949786],
          "5": [14.414039808511463, -90.68435208276561],
          "6": [14.413955217448745, -90.68438151213823],
          "7": [14.41387279107238, -90.68440549497352],
          "8": [14.413812480615949, -90.68442618862626],
          "9": [14.413723937793007, -90.6844659813496],
          "10": [14.413644705408457, -90.68449615620383],
          "11": [14.413564174103655, -90.68455985866879],
          "12": [14.413496631696557, -90.68460411511711],
          "13": [14.413440129859842, -90.68466915868414],
          "14": [14.413376484095751, -90.68472615562457],
          "15": [14.413305044950892, -90.68478784642937],
          "16": [14.413478447201108, -90.68488708815907],
          "17": [14.413509620625517, -90.68482137403849],
          "18": [14.413601192532699, -90.68475029550116],
          "19": [14.413669384354765, -90.6847026862928],
          "20": [14.413742122274586, -90.68465172432094],
          "21": [14.413826974193487, -90.68461845138192],
          "22": [14.41392374153047, -90.68458425321907],
          "23": [14.414006870484938, -90.68455541947236],
          "24": [14.414093246631554, -90.68452189186058],
          "25": [14.414184818299113, -90.68449372866553],
          "26": [14.414268596600216, -90.68444880166577],
          "27": [14.41435562208931, -90.6843938163812],
          "28": [14.414404330370783, -90.68433480778293],
          "19": [14.414477717493913, -90.6842583648291],
          "30": [14.414542012386278, -90.68418460408567]
        },
    area: [
      [14.413457, -90.684996], 
      [14.413714, -90.684752], 
      [14.414257, -90.684548], 
      [14.414434, -90.684419], 
      [14.414598, -90.684154],
      [14.414291, -90.684030],
      [14.414039, -90.684301],
      [14.413600, -90.684454],
      [14.413231, -90.684771],
      [14.413457, -90.684996]           
    ]
  },
    "25": {
    name: "Sector 25",
    coords: [14.414096, -90.683156],
    casas: {
      "1": [14.41415549004358, -90.68317032707212],
      "2": [14.4141879622607, -90.6832514638899],
      "3": [14.414219785028882, -90.68332857739438],
      "4": [14.414251607794238, -90.68340971422165],
      "5": [14.414282781109327, -90.6834841455173],
      "6": [14.414316552195741, -90.68356260012621],
      "7": [14.414344478283425, -90.683639043082],
      "8": [14.414374352698005, -90.68372219155638],
      "9": [14.414386692128947, -90.6838321621193],
      "10": [14.41438604268524, -90.68390659341495],
      "11": [14.414620491748542, -90.68401388177246],
      "12": [14.414634779494866, -90.683917992806],
      "13": [14.414627635621814, -90.6837832118112],
      "14": [14.414615296204202, -90.68368866394918],
      "15": [14.414584772378127, -90.68357735226525],
      "16": [14.414551650775582, -90.68349822710414],
      "17": [14.414523075270896, -90.68341574917942],
      "18": [14.414486308055828, -90.68334468637177],
      "19": [14.41446033031728, -90.68326556121062],
      "20": [14.414410323162054, -90.68318643604948],
      "21": [14.414392788182893, -90.6831146869627]
    },
    area: [
      [14.414626, -90.684089], 
      [14.414660, -90.683800], 
      [14.414606, -90.683582], 
      [14.414390, -90.683006], 
      [14.414083, -90.683145],
      [14.414276, -90.683676],
      [14.414328, -90.683800],
      [14.414317, -90.683966],
      [14.414626, -90.684089]
    ]
  },
    "27": {
    name: "Sector 27",
    coords: [14.412995, -90.682239],
    area: [
      [14.414385, -90.682475], 
      [14.413977, -90.682241], 
      [14.413676, -90.682080], 
      [14.413540, -90.682016], 
      [14.412974, -90.682048],
      [14.412985, -90.682220],
      [14.413431, -90.682214],
      [14.413850, -90.682357],
      [14.414263, -90.682606],
      [14.414385, -90.682475]
    ]
  },
    "28": {
    name: "Sector 28",
    coords: [14.414470, -90.683000],
    casas: {
      "1": [14.414564243058344, -90.68313778423405],
      "2": [14.41459996243209, -90.68322294436965],
      "3": [14.414628537926678, -90.6833235272047],
      "4": [14.414662958403953, -90.68340064071043],
      "5": [14.414698028318394, -90.68347641311053],
      "6": [14.414727902686222, -90.68355352662266],
      "7": [14.414755179279311, -90.68364606283183],
      "8": [14.414774662558385, -90.68372787020635],
      "9": [14.414785053639516, -90.68381638309846],
      "10": [14.414781806426719, -90.68389282605075],
      "11": [14.414773363673222, -90.68397999783842],
      "12": [14.414756478165248, -90.68407789846152],
      "13": [14.41498183465062, -90.68415769417847],
      "14": [14.414994174047951, -90.6840611346598],
      "15": [14.415004565118842, -90.68397530397655],
      "16": [14.415020801166149, -90.68388008556231],
      "17": [14.41502015172425, -90.6837701149897],
      "18": [14.415001967351024, -90.68367087325683],
      "19": [14.414992875163907, -90.68359040699129],
      "20": [14.41496624804193, -90.68350055299186],
      "21": [14.414937672590497, -90.68341606341112],
      "22": [14.414903252155959, -90.68333559714557],
      "23": [14.414877923908291, -90.68326384805879],
      "24": [14.414843503464539, -90.68317600571888]
    },
    area: [
      [14.414985, -90.684229], 
      [14.415034, -90.683663], 
      [14.415003, -90.683486], 
      [14.414863, -90.683102], 
      [14.414460, -90.682995],
      [14.414681, -90.683593],
      [14.414728, -90.683832],
      [14.414694, -90.684116],
      [14.414985, -90.684229]
    ]
  },
    "31": {
    name: "Sector 31",
    coords: [14.413439, -90.685157],
    area: [
      [14.413377, -90.686474], 
      [14.413621, -90.685498], 
      [14.413551, -90.685425], 
      [14.413556, -90.685275], 
      [14.413442, -90.685143],
      [14.413325, -90.685312],
      [14.413057, -90.686444],
      [14.413377, -90.686474]          
    ]
  },
    "33": {
    name: "Sector 33",
    coords: [14.413439, -90.686565],
    area: [
      [14.412777, -90.687705], 
      [14.413117, -90.687737], 
      [14.413579, -90.687209], 
      [14.413738, -90.686586], 
      [14.413426, -90.686552],
      [14.413294, -90.687029],
      [14.412987, -90.687295],
      [14.412865, -90.687287],
      [14.412769, -90.687710],
      [14.412777, -90.687705]           
    ]
  },
    "34": {
    name: "Sector 34",
    coords: [14.413689, -90.685527],
    area: [
      [14.413753, -90.686511], 
      [14.413977, -90.685656], 
      [14.413769, -90.685514], 
      [14.413676, -90.685511], 
      [14.413442, -90.686495],
      [14.413753, -90.686511]
      
    ]
  },
    "35": {
    name: "Sector 35",
    coords: [14.413885801023676, -90.68542952512338],
    casas: {
      "1": [14.41456698689642, -90.68494331942932],
      "2": [14.414496604158574, -90.68498693136144],
      "3": [14.414425165373599, -90.68502247062872],
      "4": [14.414347232124433, -90.68505800989837],
      "5": [14.414266243134836, -90.68508726897673],
      "6": [14.414193505386432, -90.68510604444026],
      "7": [14.41411946872437, -90.68512750211337],
      "8": [14.41403179369983, -90.6851623708292],
      "9": [14.413952561426257, -90.68522339108057],
      "10": [14.414035215582865, -90.68549353369941],
      "11": [14.41409756226918, -90.68542580792588],
      "12": [14.41417809338167, -90.68537149319332],
      "13": [14.414257325576472, -90.68534265944507],
      "14": [14.414341103850106, -90.68531583735496],
      "15": [14.41442942819739, -90.68528432139897],
      "16": [14.41452424694307, -90.68524609992116],
      "17": [14.414602829571798, -90.68520050236891],
      "18": [14.414678164958534, -90.68515423426221]
    },
    area: [
      [14.414572409931598, -90.6849255948005], 
      [14.41386185192832, -90.68526643575815], 
      [14.413881335284822, -90.68534757257592], 
      [14.41386769693545, -90.68543608546803], 
      [14.413993039830665, -90.68556617260637],
      [14.41473278644983, -90.6851389540404],
      [14.414666522759044, -90.68502592162677], 
      [14.414626580917616, -90.68503564349865], 
      [14.414572409931598, -90.6849255948005]
      
    ]
  },
    "36": {
    name: "Sector 36",
    coords: [14.415028895821449, -90.68435772064463],
    casas: {
      "1": [14.415060956494637, -90.68436794547141],
      "2": [14.415002506728607, -90.68447389272261],
      "3": [14.414968735744592, -90.68454765347148],
      "4": [14.414916780375814, -90.68462342587473],
      "5": [14.414873917187329, -90.68469249275664],
      "6": [14.414809622389656, -90.68475150135366],
      "7": [14.414755718656336, -90.68481319215893],
      "8": [14.414690124938486, -90.68487823572646],
      "9": [14.41461284122777, -90.68492517438273],
      "10": [14.414757179518418, -90.68510833488868],
      "11": [14.414833164294766, -90.68503591524919],
      "12": [14.414892263547948, -90.68499501156191],
      "13": [14.41495915609059, -90.6849427084866],
      "14": [14.415031893589294, -90.68486693608071],
      "15": [14.415079952280706, -90.68479585754353],
      "16": [14.415132557052658, -90.68472343790145],
      "17": [14.415189058460939, -90.6846516888113],
      "18": [14.415227375499569, -90.68457993972204],
      "19": [14.41527153750132, -90.68448740351666]
    },
    area: [
      [14.415028895821449, -90.68435772064463], 
      [14.41457758720622, -90.68491875785557], 
      [14.414645129284615, -90.68502738731407], 
      [14.414667210344266, -90.68501397626981], 
      [14.414735401838202, -90.68514540450356],
      [14.415010770153373, -90.68491765514528],
      [14.41529879673114, -90.6844454493828], 
      [14.415028895821449, -90.68435772064463]
    ]
  },
    "37": {
    name: "Sector 37",
    coords: [14.415006, -90.683191],
    casas: {
      "1": [14.415037112304383, -90.68327791314913],
      "2": [14.415074779926961, -90.6833657554908],
      "3": [14.415104004802483, -90.68346633832792],
      "4": [14.41513322967374, -90.68354613404124],
      "5": [14.415142321855692, -90.68363263527975],
      "6": [14.415158557892962, -90.68371108988866],
      "7": [14.415164402866084, -90.68381033161617],
      "8": [14.415166351190818, -90.68389415065636],
      "9": [14.415154661244511, -90.68397931078738],
      "10": [14.415143620739112, -90.68406581202287],
      "11": [14.415131930791468, -90.68414560773705],
      "12": [14.415104654244905, -90.68421869792827],
      "13": [14.415339102551526, -90.68430788137745],
      "14": [14.415372224037256, -90.68421601572038],
      "15": [14.415383913972711, -90.68410671570696],
      "16": [14.41539105782153, -90.6840222261281],
      "17": [14.415402747756044, -90.6839270076966],
      "18": [14.415407293841296, -90.68380094388056],
      "19": [14.415393655585277, -90.68370572546633],
      "20": [14.41538651173656, -90.68361251870871],
      "21": [14.41537157459528, -90.6835119358648],
      "22": [14.415344298078054, -90.68340397695852],
      "23": [14.415323515967442, -90.68332351069297]
    },
    area: [
      [14.415346, -90.684366], 
      [14.415426, -90.683867], 
      [14.415356, -90.683250], 
      [14.414985, -90.683143], 
      [14.415104, -90.683660],
      [14.415058, -90.684264],
      [14.415346, -90.684366]
          
    ]
  },
    "39": {
    name: "Sector 39",
    coords: [14.414153892331909, -90.68554417884731],
    casas: {
      "1": [14.41413251079049, -90.68561034810864],
      "2": [14.414236421879307, -90.68551378858999],
      "3": [14.41434487902661, -90.68547221435279]
    },
    area: [
      [14.4140565257742, -90.68565661621454], 
      [14.414261100755404, -90.68579743218348], 
      [14.414420214502782, -90.68558285546725], 
      [14.414383196213466, -90.68543399287599], 
      [14.414178621342682, -90.68550574196382],
      [14.4140565257742, -90.68565661621454]
      
    ]
  },
    "40": {
    name: "Sector 40",
    coords: [14.414055756145983, -90.68567469986527],
    casas: {
      "1": [14.414075425068502, -90.68571950123159],
      "2": [14.414053343950236, -90.68581203743697],
      "3": [14.414028015605233, -90.68590524420166],
      "4": [14.414003579072697, -90.68599384197955],
      "5": [14.413985394616663, -90.68607833155838],
      "6": [14.413962664044526, -90.6861728794204],
      "7": [14.41393473790991, -90.68628217943177],
      "8": [14.41391590400317, -90.68636801011502],
      "9": [14.413893173423936, -90.6864605463204]
    },
    area: [
      [14.414055756145983, -90.68567469986527], 
      [14.414252197279465, -90.68580641607944], 
      [14.414021807522404, -90.68654562251353], 
      [14.41383050257209, -90.68650786255002], 
      [14.413943396085008, -90.6859958031971],
      [14.414055756145983, -90.68567469986527]
      
    ]
  },
    "41": {
    name: "Sector 41",
    coords: [14.413814590544717, -90.68665165372758],
    casas: {
      "1": [14.413843205108348, -90.6866802650798],
      "2": [14.41381398006717, -90.68679358841257],
      "3": [14.413799692267881, -90.68688143075771],
      "4": [14.413778910012873, -90.68696256757939],
      "5": [14.413754231083011, -90.68706046820247],
      "6": [14.413736696051041, -90.68713221729683],
      "7": [14.413700976539298, -90.68723749399874],
      "8": [14.41363992863246, -90.68733137131242],
      "9": [14.413569788465152, -90.68740110874258],
      "10": [14.413511780441718, -90.6874792784436],
      "11": [14.413436444662286, -90.68756108581358],
      "12": [14.413407219568567, -90.68763149379595],
      "13": [14.413324739838984, -90.68770592509159]
    },
    area: [
      [14.413812750986061, -90.68666058417513], 
      [14.41366983539056, -90.6871715496276], 
      [14.413580800249417, -90.68732175454373], 
      [14.413189681181821, -90.68777975637879],
      [14.41342737354412, -90.6878388533925],
      [14.413855060165087, -90.68725116643927],
      [14.413982253055899, -90.68670780225051],
      [14.413812750986061, -90.68666058417513]    
    ]
    },
    "43": {
    name: "Sector 43",
    coords: [14.412792046733319, -90.6872716171099],
    casas: {
      "1": [14.41209514262295, -90.68705937982176],
      "2": [14.412190611811196, -90.6870942485391],
      "3": [14.412264649113402, -90.68711838842243],
      "4": [14.41234193363847, -90.68715459824325],
      "5": [14.412408826945462, -90.6871820908856],
      "6": [14.412491956463665, -90.68720354855672],
      "7": [14.41256729256573, -90.68723439396092],
      "8": [14.412644576985269, -90.68724981666182],
      "9": [14.412738097591573, -90.68728066206364]
    },
    area: [
      [14.412792046733319, -90.6872716171099], 
      [14.412073064957916, -90.68702906203357], 
      [14.412015032715145, -90.6871677758489], 
      [14.412749576710388, -90.68744930745214], 
      [14.412792046733319, -90.6872716171099]
    ]
  },
    "43 A": {
    name: "Sector 43 A",
    coords: [14.411858252154197, -90.6874331315967],
    casas: {
      "1": [],
      "2": [],
      "3": [],
      "4": [],
      "5": [],
      "6": [],
      "7": [],
      "8": [],
      "9": []
    },
    area: [
      [], 
      [], 
      [], 
      [], 
      []
    ]
  },
    "44": {
    name: "Sector 44",
    coords: [14.411646803597995, -90.68679398445391],
    casas: {
      "1": [14.411679605094122, -90.68681812002946],
      "2": [14.411765332691148, -90.68687779918025],
      "3": [14.411853658056591, -90.68693144335725],
      "4": [14.411935488882053, -90.68698173477888],
      "5": [14.412022377094935, -90.68702378862834]
    },
    area: [
      [14.411646803597995, -90.68679398445391], 
      [14.412066998458513, -90.68701929001288], 
      [14.41199231163979, -90.68716144708779], 
      [14.411555880341263, -90.68694284705477], 
      [14.411646803597995, -90.68679398445391]
    ]
  },
    "44 A": {
    name: "Sector 44 A",
    coords: [14.411324536931255, -90.6868210040151],
    casas: {
      "1": [],
      "2": [],
      "3": [],
      "4": [],
      "5": [],
      "6": [],
      "7": [],
      "8": [],
      "9": []
    },
    area: [
      [], 
      [], 
      [], 
      [], 
      []
    ]
  },
    "45": {
    name: "Sector 45",
    coords: [14.412876993721225, -90.68688949370079],
    casas: {
      "1": [14.411784974137158, -90.686671252693],
      "2": [14.411834332430118, -90.68675104840634],
      "3": [14.411924606121861, -90.68678323491257],
      "4": [14.412003189667736, -90.68683017357311],
      "5": [14.412078525933156, -90.68686973615814],
      "6": [14.412151913821756, -90.68690929873908],
      "7": [14.412230497286844, -90.68693545027875],
      "8": [14.41230453457559, -90.68697031899706],
      "9": [14.412385715784783, -90.68700183495423],
      "10": [14.412462350819618, -90.68703938588021],
      "11": [14.412546779216914, -90.68706821962644],
      "12": [14.412626661440793, -90.68709101840302],
      "13": [14.412716285364322, -90.68711113497062],
      "14": [14.412801363112365, -90.68714265092464],
      "15": [14.412798765317957, -90.68689789934544],
      "16": [14.41273576881941, -90.6868730889119],
      "17": [14.412642897660932, -90.68684961958444],
      "18": [14.412554572605734, -90.68682547970205],
      "19": [14.412485081543988, -90.68679530484862],
      "20": [14.412388313583833, -90.68675842447287],
      "21": [14.412312327972808, -90.68671752078347],
      "22": [14.412242836836002, -90.68668131096116],
      "23": [14.412085020436509, -90.68660218579768],
      "24": [14.41208925923556, -90.68660622130099],
      "25": [14.411995738354898, -90.68657135258293],
      "26": [14.411918453710445, -90.68651972006252]
    },
    area: [
      [14.412876993721225, -90.68688949370079], 
      [14.412808504278093, -90.68719502605552], 
      [14.412243142733862, -90.68700470772242], 
      [14.411671617427873, -90.68670487574889],
      [14.411759663312507, -90.68656293401838],
      [14.411904861713676, -90.68648478632467],
      [14.412876993721225, -90.68688949370079]    
    ]
    },
    "46": {
    name: "Sector 46",
    coords: [14.412974945053351, -90.68650363826477],
    casas: {
      "1": [14.412133021796246, -90.68646083239894],
      "2": [14.412195369015153, -90.68651380602725],
      "3": [14.412270055765454, -90.68655269806057],
      "4": [14.412349288637646, -90.68659159009071],
      "5": [14.412444757716633, -90.68661170665827],
      "6": [14.412536979511122, -90.68664858703309],
      "7": [14.412632448510365, -90.68668278519866],
      "8": [14.41271492849742, -90.68670558397517],
      "9": [14.412779873347713, -90.68674179379627],
      "10": [14.41288183672376, -90.68675118152834],
      "11": [14.41291329304992, -90.68651315872197],
      "12": [14.412818692891653, -90.6864868933802],
      "13": [14.41274078685021, -90.68645734487518],
      "14": [14.41265890598139, -90.68642533399472],
      "15": [14.412566690595797, -90.68639906865252],
      "16": [14.41248639958436, -90.68637936964916],
      "17": [14.412406108544003, -90.68633504689161],
      "18": [14.412317867862342, -90.68628662017503]
    },
    area: [
      [14.412974945053351, -90.68650363826477], 
      [14.412899609092486, -90.68680404565617], 
      [14.412503221831928, -90.68669863662137], 
      [14.412048795652865, -90.6864936792177],
      [14.412072149482997, -90.68638316297536],
      [14.41230276842724, -90.68623949185698],
      [14.412974945053351, -90.68650363826477]

          
    ]
    },

    "47": {
    name: "Sector 47",
    coords: [14.412330, -90.686106],
    area: [
      [14.41260280449537, -90.68626879505618], 
      [14.412776343604602, -90.68555887656237], 
      [14.41251439288715, -90.68548874633106], 
      [14.412352030531524, -90.6861505813859],
      [14.41260280449537, -90.68626879505618]
          
    ]
  },
    "50": {
    name: "Sector 50",
    coords: [14.415486, -90.683328],
    casas: {
      "1": [14.415439345170995, -90.68342110789638],
      "2": [14.41547766216601, -90.68375772511013],
      "3": [14.415488702654873, -90.68384757910665],
      "4": [14.415809526039267, -90.68377583002051],
      "5": [14.415798485566295, -90.68368932878504],
      "6": [14.415777054058376, -90.68359813368248],
      "7": [14.4157653641447, -90.68353644287424],
      "8": [14.415742633751474, -90.68345798826223]
    },
    area: [
      [14.415842, -90.683845], 
      [14.415777, -90.683403], 
      [14.415676, -90.683336], 
      [14.415476, -90.683312], 
      [14.415517, -90.683864],
      [14.415842, -90.683845]
          
    ]
  },
    "51": {
    name: "Sector 51",
    coords: [14.415435728796773, -90.68324080911506],
    casas: {
          "1": [14.415487911738706, -90.6832396709814],
          "2": [14.415565844587634, -90.68324704705749],
          "3": [14.415650921249325, -90.68327252804325],
          "4": [14.41571976188372, -90.68331343173207],
          "5": [14.415774964263738, -90.68336171149603],
          "6": [14.415817177839601, -90.68343010782702],
          "7": [14.415834712706921, -90.6835219734844],
          "8": [14.415852897012488, -90.68360512196377],
          "9": [14.415871730756017, -90.68368290602434],
          "10": [14.415905501602529, -90.68378348886388],
          "11": [14.415981485987755, -90.68386730789884],
          "12": [14.416037337741395, -90.68393570422681],
          "13": [14.416084097338235, -90.68400141834813],
          "14": [14.416104229939213, -90.6840926134491],
          "15": [14.416099034429454, -90.6841858202067],
          "16": [14.415869782437019, -90.6839880072971],
          "17": [14.41578925193551, -90.68399538337262],
          "18": [14.415701577568251, -90.68400879441687],
          "19": [14.415628190846649, -90.68401751159543],
          "20": [14.41554571193882, -90.68405573307155]
        },
    area: [
      [14.4154459, -90.6831506], 
      [14.4154699, -90.6830151], 
      [14.4156778, -90.6830366], 
      [14.4158719, -90.6831747], 
      [14.4159791, -90.6834476],
      [14.4160512, -90.6836998],
      [14.4161434, -90.6838996], 
      [14.4161564, -90.6841457], 
      [14.4155784, -90.6841712], 
      [14.4155836, -90.6839660], 
      [14.4160246, -90.6839398],
      [14.4159213, -90.6835777],
      [14.4158213, -90.6832317], 
      [14.4156239, -90.6831734], 
      [14.4154459, -90.6831506]     
    ]
  },
    "54": {
    name: "Sector 54",
    coords: [14.411328677320471, -90.6880053469966],
    area: [
      [14.411328677320471, -90.6880053469966], 
      [14.411767057417672, -90.68818840775607], 
      [14.411689123239606, -90.68852435443004], 
      [14.411326728962761, -90.68835336361101], 
      [14.411328677320471, -90.6880053469966]
          
    ]
  },
    "55": {
    name: "Sector 55",
    coords: [14.411365861606651, -90.68849423734909],
    area: [
      [14.411341455144859, -90.68849642859807], 
      [14.411438019831783, -90.68952193420456], 
      [14.411578091609655, -90.68953179483523], 
      [14.411687389981257, -90.68859065241864], 
      [14.41149850538303, -90.68851614987578],
      [14.411341455144859, -90.68849642859807]
          
    ]
  },
    "59": {
    name: "Sector 59",
    coords: [14.41215215159753, -90.6888123336132],
    area: [
      [14.41215215159753, -90.6888123336132], 
      [14.412066497775683, -90.68946422165435], 
      [14.412349978776259, -90.68954784792892], 
      [14.412433355472528, -90.68893171905302], 
      [14.412342832200828, -90.68882964580612],
      [14.41215215159753, -90.6888123336132]
          
    ]
  },
    "60": {
    name: "Sector 60",
    coords: [14.412359811909731, -90.68776371981113],
    area: [
      [14.412359811909731, -90.68776371981113], 
      [14.412181022556627, -90.68868342535119], 
      [14.412373691467831, -90.68870351921343], 
      [14.412472945084366, -90.68861812029888], 
      [14.412635448459207, -90.68785254414736],
      [14.412359811909731, -90.68776371981113]
          
    ]
  },
}

// Localizar usuario sin cambiar la vista
map.locate({ 
  setView: false,
  enableHighAccuracy: true,
  watch: true
});

map.on('locationfound', function (e) {
  userLocation = e.latlng;

  // Crear o mover marcador del usuario
  if (!userMarker) {
    userMarker = L.marker(userLocation, {
      icon: L.divIcon({
        html: '<div style="background:#3388ff;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>',
        iconSize: [16, 16]
      })
    }).addTo(map).bindPopup("Tu ubicaci√≥n");
  } else {
    userMarker.setLatLng(userLocation);
  }

  // üîÅ Actualizar ruta si ya hay un destino
  if (routingControl && destinationLatLng) {
    routingControl.setWaypoints([
      L.latLng(userLocation.lat, userLocation.lng),
      destinationLatLng
    ]);
  }
});

map.on('locationerror', function () {
  alert("No se pudo obtener tu ubicaci√≥n");
});


// Crear capas de pol√≠gonos para todos los sectores
const sectorLayers = {};

Object.keys(sectores).forEach(sectorId => {
  const sector = sectores[sectorId];
  
  if (sector.area) {
    // Crear pol√≠gono para el sector
    const polygon = L.polygon(sector.area, {
      color: "#e4f3e6",
      fillColor: "transparent",
      fillOpacity: 0,
      weight: 2,
      interactive: true,
      className: `sector-polygon sector-${sectorId}`
    }).addTo(map);
    
    // Variables para controlar el estado del popup
    let popupTimeout;
    let isPopupOpen = false;
    const popupCloseDelay = 100; // Milisegundos antes de cerrar
    
    // Crear contenido del popup
    const popupContent = `
      <div class="sector-info">
        <h3>${sector.name}</h3>
        <p><strong>Total de casas:</strong> ${sector.n_casas || 'No disponible'}</p>
        ${sector.comercios ? `<p><strong>Comercios:</strong> ${sector.comercios.join(', ')}</p>` : ''}
        <button class="route-btn" data-sector="${sectorId}">Trazar ruta</button>
      </div>
    `;
    
    // Configurar popup
    polygon.bindPopup(popupContent, {
      closeButton: true,
      autoClose: false, // Desactivamos el cierre autom√°tico
      closeOnClick: false,
      className: 'sector-popup',
      maxWidth: 300
    });
    
    // Eventos para desktop
    if (window.innerWidth > 768) {
      polygon.on('mouseover', function() {
        clearTimeout(popupTimeout);
        this.setStyle({
          weight: 3,
          color: "#e4f3e6"
        });
        if (!isPopupOpen) {
          this.openPopup();
          isPopupOpen = true;
        }
      });
      
      polygon.on('mouseout', function() {
        // Solo cerrar si el mouse no est√° sobre el popup
        if (!this._popup._container.matches(':hover')) {
          popupTimeout = setTimeout(() => {
            this.closePopup();
            isPopupOpen = false;
            this.setStyle({
              weight: 2,
              color: "#e4f3e6"
            });
          }, popupCloseDelay);
        }
      });
      
      // Manejar cuando el mouse entra/sale del popup
      polygon.on('popupopen', function() {
        const popup = this._popup._container;
        popup.addEventListener('mouseenter', () => clearTimeout(popupTimeout));
        popup.addEventListener('mouseleave', () => {
          popupTimeout = setTimeout(() => {
            this.closePopup();
            isPopupOpen = false;
            this.setStyle({
              weight: 2,
              color: "#e4f3e6"
            });
          }, popupCloseDelay);
        });
      });
    }
    
    // Eventos para m√≥viles
    polygon.on('click', function(e) {
      if (window.innerWidth <= 768) {
        Object.values(sectorLayers).forEach(layer => {
          if (layer !== this) layer.closePopup();
        });
        this.openPopup(e.latlng);
      }
    });
    
    sectorLayers[sectorId] = polygon;
  }
});

function mostrarInfoSector(sectorKey) {
  const sector = sectores[sectorKey];

  const contenido = `
    <strong>${sector.name}</strong><br><br>
    <button onclick="trazarRutaASector('${sectorKey}')">
      üß≠ Trazar ruta
    </button>
  `;

  L.popup()
    .setLatLng(sector.coords)
    .setContent(contenido)
    .openOn(map);
}

// Funci√≥n para manejar el clic en el bot√≥n de ruta desde el popup
document.addEventListener('click', function(e) {
  if (e.target && e.target.classList.contains('route-btn')) {
    const sectorId = e.target.getAttribute('data-sector');
    trazarRutaASector(sectorId); // ‚úÖ RUTA DIRECTA
  }
});

// Funci√≥n para buscar sector y mostrar ruta
let areaResaltada; // Global para borrar la anterior

function buscarSector() {
  const sectorSelect = document.getElementById("sectorSelect").value.trim();
  const destino = sectores[sectorSelect];

  if (!destino) {
    alert("Sector no encontrado.");
    return;
  }

  if (!userLocation) {
    alert("Esperando ubicaci√≥n actual...");
    return;
  }

  // Cerrar todos los popups (por si hay alguno abierto)
  Object.values(sectorLayers).forEach(layer => {
    layer.closePopup();
    layer.setStyle({
      weight: 2,
      color: "#e4f3e6"
    });
  });

  // Resaltar el sector seleccionado SIN abrir popup
  if (sectorLayers[sectorSelect]) {
    sectorLayers[sectorSelect].setStyle({
      weight: 3,
      color: "#00ff15"
    });
    // NOTA: Hemos eliminado el .openPopup() que estaba aqu√≠
  }

  // Eliminar ruta anterior si existe
  if (routingControl) {
    map.removeControl(routingControl);
  }

  // Mostrar ruta
  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(userLocation.lat, userLocation.lng),
      L.latLng(destino.coords[0], destino.coords[1])
    ],
    routeWhileDragging: false,
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1'
    })
  }).addTo(map);

  // Opcional: Centrar el mapa en el sector seleccionado
  map.setView(destino.coords, 17);
}

// Agregar todos los pol√≠gonos al mapa (pero ocultos inicialmente)
const overlayLayers = {};
Object.keys(sectorLayers).forEach(sectorId => {
  overlayLayers[sectores[sectorId].name] = sectorLayers[sectorId];
});

routingControl.on('routingerror', function(err) {
  alert("No se pudo calcular la ruta. Intenta m√°s tarde.");
});

// Reemplaza esta secci√≥n al final del archivo:
// Agrega despu√©s de crear el mapa
L.control.locate({
  position: 'topleft',
  drawCircle: true,
  flyTo: true, // Solo vuela a la ubicaci√≥n cuando el usuario lo pide
  keepCurrentZoomLevel: true,
  markerStyle: {
    color: '#3388ff'
  },
  locateOptions: {
    enableHighAccuracy: true
  }
}).addTo(map);


// Control de ubicaci√≥n mejorado
const locateControl = L.control.locate({
  position: 'topleft',
  drawCircle: true,
  flyTo: true,
  keepCurrentZoomLevel: false,
  setView: 'always', // Siempre centra al usuario cuando se activa
  initialZoomLevel: 17,
  locateOptions: {
    enableHighAccuracy: true,
    maxZoom: 17,
    timeout: 10000
  },
  markerStyle: {
    color: '#3388ff',
    fillColor: '#3388ff',
    opacity: 1,
    fillOpacity: 0.5,
    weight: 2
  },
  circleStyle: {
    color: '#3388ff',
    fillColor: '#3388ff',
    fillOpacity: 0.15,
    weight: 1
  },
  strings: {
    title: "Mostrar mi ubicaci√≥n",
    popup: "Est√°s aqu√≠",
    outsideMapBoundsMsg: "Est√°s fuera del √°rea del mapa"
  },
  clickBehavior: {
    inView: 'setView',
    outOfView: 'setView',
    inViewNotFollowing: 'setView'
  }
}).addTo(map);

// Opcional: Actualizar userLocation cuando se activa el control
map.on('locate', function(e) {
  if (e.latlng) {
    userLocation = e.latlng;
    console.log("Ubicaci√≥n actualizada:", userLocation);
  }
});

// boton para fijar al usuario
function centrarEnUsuario() {
  if (!userLocation) {
    alert("Obteniendo tu ubicaci√≥n... Por favor espera.");
    map.locate({setView: true, maxZoom: 17});
    return;
  }
  
  // Centrar en la ubicaci√≥n del usuario
  map.setView(userLocation, 17);
  
  // Resaltar la ubicaci√≥n con un popup
  L.popup()
    .setLatLng(userLocation)
    .setContent("Tu ubicaci√≥n actual")
    .openOn(map);
}

// Tambi√©n puedes agregar un atajo de teclado
document.addEventListener('keydown', function(e) {
  // Ctrl + L para centrar en ubicaci√≥n
  if (e.ctrlKey && e.key === 'l') {
    e.preventDefault();
    centrarEnUsuario();
  }
});



// Variables para el modal de b√∫squeda -----------------------------------------------------
let currentSelectedSector = null;

// Inicializar el modal de b√∫squeda
function initSearchModal() {
  const sectorList = document.getElementById('sectorList');
  const sectorSelect = document.getElementById('sectorSelect');
  
  // Limpiar listas existentes
  sectorList.innerHTML = '';
  sectorSelect.innerHTML = '<option value="" disabled selected hidden>Seleccione un sector</option>';
  
  // Ordenar sectores num√©ricamente
  const sortedSectorIds = Object.keys(sectores).sort((a, b) => parseInt(a) - parseInt(b));
  
  // Crear elementos para la lista visual y el select
  sortedSectorIds.forEach(sectorId => {
    const sector = sectores[sectorId];
    
    // Elemento para la lista visual
    const sectorItem = document.createElement('div');
    sectorItem.className = 'sector-item';
    sectorItem.setAttribute('data-sector', sectorId);
    sectorItem.innerHTML = `
      <div class="sector-number">${sectorId}</div>
      <div class="sector-label">${sector.name}</div>
    `;
    sectorItem.onclick = function() {
      selectSector(sectorId);
    };
    sectorList.appendChild(sectorItem);
    
    // Opci√≥n para el select (compatibilidad)
    const option = document.createElement('option');
    option.value = sectorId;
    option.textContent = `${sector.name} (Sector ${sectorId})`;
    sectorSelect.appendChild(option);
  });
  
  // Cerrar modal al hacer clic fuera
  document.getElementById('searchModal').onclick = function(e) {
    if (e.target === this) {
      toggleSearchModal();
    }
  };
  
  // Permitir b√∫squeda con Enter
  document.getElementById('searchSectorInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const firstSector = document.querySelector('.sector-item:not([style*="display: none"])');
      if (firstSector) {
        firstSector.click();
      }
    }
  });
}

// Alternar visibilidad del modal
function toggleSearchModal() {
  const modal = document.getElementById('searchModal');
  modal.classList.toggle('active');
  
  if (modal.classList.contains('active')) {
    // Enfocar el input cuando se abre el modal
    setTimeout(() => {
      document.getElementById('searchSectorInput').focus();
    }, 100);
  } else {
    // Limpiar b√∫squeda cuando se cierra
    clearSearch();
  }
}

// Filtrar sectores seg√∫n la b√∫squeda - VERSI√ìN FINAL
function filterSectors() {
  const inputRaw = document.getElementById("searchSectorInput").value;
  const sectorList = document.getElementById("sectorList");
  const noResults = document.getElementById("noResults");

  sectorList.innerHTML = "";
  noResults.style.display = "none";

  if (inputRaw.trim() === "") return;

  const sectorKey = normalizarEntradaSector(inputRaw);

  if (sectores[sectorKey]) {
    const sector = sectores[sectorKey];

    const item = document.createElement("div");
    item.className = "sector-item";
    item.textContent = sector.name;

    item.onclick = () => {
      toggleSearchModal(); // üîç SOLO AQU√ç
      trazarRutaASector(sectorKey);
    };

    sectorList.appendChild(item);
  } else {
    noResults.style.display = "block";
  }
}

function trazarRutaASector(sectorKey) {
  const sector = sectores[sectorKey];
  const houseNumber = document.getElementById("houseNumber")?.value;

  if (!sector || !userLocation) {
    alert("Datos incompletos");
    return;
  }

  let destinoCoords = sector.coords;
  let popupTexto = sector.name;

  // üîπ Si el usuario ingres√≥ casa y existe
  if (houseNumber && sector.casas && sector.casas[houseNumber]) {
    destinoCoords = sector.casas[houseNumber];
    popupTexto += `<br>Casa ${houseNumber}`;
  }

  // Limpiar rutas previas
  if (routingControl) {
    map.removeControl(routingControl);
  }

  destinationLatLng = L.latLng(destinoCoords[0], destinoCoords[1]);

  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(userLocation.lat, userLocation.lng),
      destinationLatLng
    ],
    routeWhileDragging: false,
    router: L.Routing.osrmv1({
      serviceUrl: "https://router.project-osrm.org/route/v1"
    })
  }).addTo(map);

  map.setView(destinoCoords, 18);

  L.popup()
    .setLatLng(destinoCoords)
    .setContent(popupTexto)
    .openOn(map);
}





// Seleccionar un sector desde el modal
function selectSector(sectorId) {
  // Quitar selecci√≥n anterior
  if (currentSelectedSector) {
    const prevItem = document.querySelector(`.sector-item[data-sector="${currentSelectedSector}"]`);
    if (prevItem) prevItem.classList.remove('selected');
  }
  
  // Marcar como seleccionado
  const selectedItem = document.querySelector(`.sector-item[data-sector="${sectorId}"]`);
  if (selectedItem) selectedItem.classList.add('selected');
  currentSelectedSector = sectorId;
  
  // Establecer valor en el select (compatibilidad)
  document.getElementById('sectorSelect').value = sectorId;
  
  // Cerrar modal
  toggleSearchModal();
  
  // Buscar el sector seleccionado
  buscarSector();
}

// Limpiar b√∫squeda
function clearSearch() {
  document.getElementById('searchSectorInput').value = '';
  filterSectors();
}

// Inicializar modal cuando se cargue la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  initSearchModal();
  
  // Cerrar modal con Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('searchModal');
      if (modal.classList.contains('active')) {
        toggleSearchModal();
      }
    }
  });
});

// Mantener la funci√≥n buscarSector original para compatibilidad
function buscarSector() {
  const sectorId = document.getElementById("sectorSelect").value;
  if (!sectorId) return;

  toggleSearchModal(); // üîç SOLO MODAL
  trazarRutaASector(sectorId);
}

function normalizarEntradaSector(texto) {
  if (!texto) return null;

  // Convertir a min√∫sculas
  texto = texto.toLowerCase();

  // Quitar la palabra "sector"
  texto = texto.replace(/sector/g, "");

  // Extraer solo n√∫meros
  const numero = texto.match(/\d+/);

  if (!numero) return null;

  // Quitar ceros a la izquierda (014 ‚Üí 14)
  return numero[0].replace(/^0+/, "") || "0";
}
document.querySelector('.floating-location-btn')
  .classList.add('active');

  window.addEventListener("resize", () => {
  map.invalidateSize();
});
